var u=Object.defineProperty;var f=(r,t,e)=>t in r?u(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var d=(r,t,e)=>(f(r,typeof t!="symbol"?t+"":t,e),e);import{P as h}from"./pg-event-f7ab3da9.js";class C{constructor(t){d(this,"moveDrag",t=>{!this.draggedItem||t.pointerId!==this.pointerId||(this.draggedItem.style.left=`${t.clientX-this.offsetX}px`,this.draggedItem.style.top=`${t.clientY-this.offsetY}px`)});d(this,"endDrag",t=>{if(!this.draggedItem||t.pointerId!==this.pointerId)return;this.draggedItem.hidden=!0,document.elementFromPoint(t.clientX,t.clientY),this.draggedItem.hidden=!1,console.groupEnd();const e=this.categories.find(s=>{const n=s.element.getBoundingClientRect();return t.clientX>=n.left&&t.clientX<=n.right&&t.clientY>=n.top&&t.clientY<=n.bottom});(e?e.element:this.base.element).appendChild(this.draggedItem),Object.assign(this.draggedItem.style,{position:"",zIndex:"",left:"",top:""}),this.draggedItem.releasePointerCapture(this.pointerId),this.draggedItem.removeEventListener("pointermove",this.moveDrag),this.draggedItem.removeEventListener("pointerup",this.endDrag),this.draggedItem.removeEventListener("pointercancel",this.endDrag),this.draggedItem=null,this.pointerId=null,this.updateState()});if(!t.base||!t.base.element||!t.categories||!t.verifyButton)throw new Error("Invalid configuration: base, categories, and verifyButton are required.");this.base=t.base,this.categories=t.categories,this.onChange=t.onChange,this.messages=t.messages,t.verifyButton.addEventListener("click",()=>this.validateItems());const e=document.querySelector(".reset-button");e&&e.addEventListener("click",()=>this.resetActivity()),this.initDraggableItems(),this.initCategories(),this.initBase(),this.pgEvent=new h}initDraggableItems(){this.base.items.forEach(({element:t})=>{if(!t){console.error("Invalid item element");return}t.classList.add("item"),t.style.cursor="grab",t.addEventListener("pointerdown",e=>this.startDrag(e,t),{passive:!1})})}initCategories(){this.categories.forEach(t=>{t.element||console.error("Invalid category element",t)})}initBase(){this.base.element||console.error("Invalid base element")}handleDrop(t,e){t.preventDefault();const s=t.dataTransfer.getData("text/plain"),n=document.querySelector(`#${s}`);n&&(e.element.appendChild(n),this.updateState())}startDrag(t,e){t.preventDefault(),this.draggedItem=e,this.pointerId=t.pointerId,e.setPointerCapture(this.pointerId);const s=e.getBoundingClientRect();this.offsetX=t.clientX-s.left,this.offsetY=t.clientY-s.top,Object.assign(e.style,{position:"absolute",zIndex:9999,left:`${t.clientX-this.offsetX}px`,top:`${t.clientY-this.offsetY}px`}),e.addEventListener("pointermove",this.moveDrag,{passive:!1}),e.addEventListener("pointerup",this.endDrag,{passive:!1}),e.addEventListener("pointercancel",this.endDrag,{passive:!1})}validateItems(){const t=new h;t.getValues();const e=this.getState();t.postToPg({event:this.areItemsCorrect()?"SUCCESS":"FAILURE",message:this.areItemsCorrect()?this.messages.onSuccess:this.messages.onFail,reasons:[],state:JSON.stringify(e)})}resetActivity(){const t={base:this.base.items.map(s=>s.element.id),categories:this.categories.map(s=>({name:s.name,items:[]}))};this.categories.forEach(s=>{Array.from(s.element.querySelectorAll(".item")).forEach(n=>{this.base.element.appendChild(n)})}),this.loadState(t);const e=new h;e.getValues(),e.postToPg({event:"FAILURE",message:this.messages.onReset,reasons:[],state:JSON.stringify(t)})}areItemsCorrect(){let t=!0;return this.categories.forEach(e=>{Array.from(e.element.querySelectorAll(".item")).forEach(s=>{const n=this.base.items.find(o=>o.element===s);(!n||n.expectedCategory!==e.name)&&(t=!1)})}),Array.from(this.base.element.querySelectorAll(".item")).forEach(e=>{const s=this.base.items.find(n=>n.element===e);(!s||s.expectedCategory!=="base")&&(t=!1)}),t}updateState(){const t=Array.from(this.base.element.querySelectorAll(".item")),e=this.categories.map(s=>({name:s.name,items:Array.from(s.element.querySelectorAll(".item"))}));this.onChange&&this.onChange(t,e)}getState(){const t=Array.from(this.base.element.querySelectorAll(".item")),e=this.categories.map(s=>({name:s.name,items:Array.from(s.element.querySelectorAll(".item")).map(n=>n.id)}));return{base:t.map(s=>s.id),categories:e}}loadState(t){this.categories.forEach(e=>{Array.from(e.element.querySelectorAll(".item")).forEach(s=>{this.base.element.appendChild(s)})}),this.categories.forEach(e=>{const s=e.element.querySelector(".drop-zone-title");e.element.innerHTML="",s&&e.element.appendChild(s)}),t.base.forEach(e=>{const s=document.getElementById(e);s?this.base.element.appendChild(s):console.warn(`Item with ID "${e}" not found in the DOM.`)}),t.categories.forEach(e=>{const s=this.categories.find(n=>n.name===e.name);s?e.items.forEach(n=>{const o=document.getElementById(n);o?s.element.appendChild(o):console.warn(`Item with ID "${n}" not found for category "${e.name}".`)}):console.warn(`Category "${e.name}" not found.`)})}}class E{constructor(t){this.categories=t.categories,this.expectations=t.expectations,this.connectorColor=t.connector.color||"#000000",this.connectorWidth=t.connector.width||2,this.connectorRadius=t.connector.radius||5,this.onChange=t.onChange,this.connectorsContainer=t.connector.container,this.messages=t.messages,this.connectorsContainer.innerHTML="",this.relations={},this.connectorIdCounter=0,this.initItems(),this.setupDraggableItems(),this.pgEvent=new h,this.verifyButton=t.verifyButton,this.verifyButton.addEventListener("click",()=>this.validateConnections()),document.querySelector(".reset-button").addEventListener("click",()=>this.resetActivity())}initItems(){this.categories.forEach(t=>{t.items.forEach(e=>{e.element&&(e.element.addEventListener("mousedown",s=>this.onItemDragStart(s,e)),e.element.addEventListener("touchstart",s=>this.onItemDragStart(s,e)))})})}setupDraggableItems(){this.connector=null,this.startItem=null,document.addEventListener("mousemove",t=>{this.connector&&this.updateConnectorPosition(t.clientX,t.clientY)}),document.addEventListener("mouseup",t=>{this.connector&&this.finalizeConnector(t)}),document.addEventListener("touchmove",t=>{if(this.connector){const e=t.touches[0];this.updateConnectorPosition(e.clientX,e.clientY)}}),document.addEventListener("touchend",t=>{this.connector&&this.finalizeConnector(t)})}onItemDragStart(t,e){t.preventDefault(),this.startItem=e;const s=t.touches?t.touches[0].clientX:t.clientX,n=t.touches?t.touches[0].clientY:t.clientY;this.connector=document.createElement("div");const o=`connector-${this.connectorIdCounter++}`;this.connector.id=o,this.connector.style.position="absolute",this.connector.style.left=`${s}px`,this.connector.style.top=`${n}px`,this.connector.style.width="2px",this.connector.style.height="2px",this.connector.style.backgroundColor=this.connectorColor,this.connector.style.borderRadius=`${this.connectorRadius}px`,this.connector.dataset.relationKey=`${this.startItem.name}-${o}`,this.connector.startX=s,this.connector.startY=n,this.connectorsContainer.appendChild(this.connector)}updateConnectorPosition(t,e){if(!this.connector)return;const s=this.connector.startX,n=this.connector.startY,o=t-s,i=e-n,a=Math.atan2(i,o)*180/Math.PI;this.connector.style.width=`${Math.abs(o)}px`,this.connector.style.height="4px",this.connector.style.transform=`rotate(${a}deg)`,this.connector.style.transformOrigin="0% 50%",this.connector.style.left=`${s}px`,this.connector.style.top=`${n}px`}updateConnectorPosition(t,e){if(!this.connector)return;const s=this.connector.startX,n=this.connector.startY,o=t-s,i=e-n,a=Math.atan2(i,o)*180/Math.PI;this.connector.style.width=`${Math.abs(o)}px`,this.connector.style.height="4px",this.connector.style.transform=`rotate(${a}deg)`,this.connector.style.transformOrigin="0% 50%",this.connector.style.left=`${s}px`,this.connector.style.top=`${n}px`}finalizeConnector(t){const e=t.changedTouches?t.changedTouches[0].clientX:t.clientX,s=t.changedTouches?t.changedTouches[0].clientY:t.clientY,n=document.elementFromPoint(e,s);if(!n||!this.isItemInCategories(n)||n===this.startItem.element){this.connectorsContainer.removeChild(this.connector),this.connector=null,this.startItem=null;return}const o=this.categories.flatMap(i=>i.items).find(i=>i.element===n);this.relations[this.connectorIdCounter]={connector:this.connector,start:this.startItem,target:o},this.updateConnectorPositionForLoadedState(this.connector,this.startItem.element,o.element),this.connector=null,this.startItem=null}removeConnectorAndRelation(t){const e=document.getElementById(t);if(e){e.parentElement.removeChild(e);for(const s in this.relations){const n=this.relations[s];if(n.connector&&n.connector.id===t){delete this.relations[s];break}}this.onChange&&this.onChange(this.relations)}}isItemInCategories(t){return this.categories.some(e=>e.items.some(s=>s.element===t))}resetActivity(){this.connectorsContainer.innerHTML="",this.relations={};const t=[],e=new h;e.getValues(),e.postToPg({event:"FAILURE",message:this.messages.onReset,reasons:[],state:JSON.stringify(t)})}validateConnections(){let t=!0;const e=new Set;for(const o in this.relations){const i=this.relations[o];if(!this.expectations.find(c=>{const l=c[0]===i.start.name&&c[1]===i.target.name||c[0]===i.target.name&&c[1]===i.start.name;return l&&e.add(c),l})){t=!1;break}}e.size!==this.expectations.length&&(t=!1);const s=new h;s.getValues();let n=this.getState();s.postToPg({event:t?"SUCCESS":"FAILURE",message:t?this.messages.onSuccess:this.messages.onFail,reasons:[],state:JSON.stringify(n)})}getState(){return Object.keys(this.relations).map(t=>{const e=this.relations[t];return{start:e.start.name,target:e.target.name,connectorId:e.connector.id}})}loadState(t){this.connectorsContainer.innerHTML="",this.relations={},t.forEach(e=>{const s=this.categories.flatMap(o=>o.items).find(o=>o.name===e.start),n=this.categories.flatMap(o=>o.items).find(o=>o.name===e.target);if(s&&n){const o=document.createElement("div");o.id=e.connectorId,o.style.position="absolute",o.style.backgroundColor=this.connectorColor,o.style.width=`${this.connectorWidth}px`,o.style.height=`${this.connectorWidth}px`,o.style.borderRadius=`${this.connectorRadius}px`,o.style.cursor="pointer",o.style.pointerEvents="auto",this.connectorsContainer.appendChild(o),this.relations[e.connectorId]={connector:o,start:s,target:n},this.updateConnectorPositionForLoadedState(o,s.element,n.element)}})}updateConnectorPositionForLoadedState(t,e,s){const n=e.getBoundingClientRect(),o=s.getBoundingClientRect(),i=n.left+n.width/2,a=n.top+n.height/2,c=o.left+o.width/2,l=o.top+o.height/2,m=c-i,g=l-a,p=Math.atan2(g,m)*180/Math.PI;t.style.width=`${Math.abs(m)}px`,t.style.height="4px",t.style.transform=`rotate(${p}deg)`,t.style.transformOrigin="0% 50%",t.style.left=`${i}px`,t.style.top=`${a}px`}}export{C as D,E as a};
