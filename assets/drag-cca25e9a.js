import{P as r}from"./pg-event-f7ab3da9.js";class u{constructor(t){if(!t.base||!t.base.element||!t.categories||!t.verifyButton)throw new Error("Invalid configuration: base, categories, and verifyButton are required.");this.base=t.base,this.categories=t.categories,this.onChange=t.onChange,this.messages=t.messages,this.pgEvent=new r,this.pgEvent.getValues(),this.pgEvent.data.state&&this.loadState(JSON.parse(this.pgEvent.data.state)),t.verifyButton.addEventListener("click",()=>this.validateItems()),this.initDraggableItems(),this.initCategories(),this.initBase()}initDraggableItems(){this.base.items.forEach((t,s)=>{if(!t.element){console.error("Invalid item element",t);return}t.element.setAttribute("draggable",!0),t.element.classList.add("item"),t.element.dataset.itemId=`item-${s}`,t.element.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",t.element.dataset.itemId)})})}initCategories(){this.categories.forEach(t=>{if(!t.element){console.error("Invalid category element",t);return}t.element.addEventListener("dragover",s=>{s.preventDefault()}),t.element.addEventListener("drop",s=>{s.preventDefault();const e=s.dataTransfer.getData("text/plain");if(!e){console.error("No data received on drop event");return}const o=document.querySelector(`[data-item-id="${e}"]`);o?(t.element.appendChild(o),this.updateState()):console.warn("Dragged element not found.")})})}initBase(){this.base.element.addEventListener("dragover",t=>{t.preventDefault()}),this.base.element.addEventListener("drop",t=>{t.preventDefault();const s=t.dataTransfer.getData("text/plain");if(!s){console.error("No data received on drop event");return}const e=document.querySelector(`[data-item-id="${s}"]`);e?(this.base.element.appendChild(e),this.updateState()):console.warn("Dragged element not found.")})}validateItems(){let t=!0;this.categories.forEach(e=>{Array.from(e.element.querySelectorAll(".item")).forEach(o=>{const n=this.base.items.find(a=>a.element===o);n?n.expectedCategory!==e.name&&(t=!1):(console.error("Unable to validate item: Missing reference.",o),t=!1)})}),Array.from(this.base.element.querySelectorAll(".item")).forEach(e=>{const o=this.base.items.find(n=>n.element===e);o?o.expectedCategory!=="base"&&(t=!1):(console.error("Unable to validate item: Missing reference.",e),t=!1)}),new r().postToPg({event:t?"SUCCESS":"FAILURE",message:t?this.messages.onSuccess:this.messages.onFail,reasons:[],state:JSON.stringify(this.getState())})}updateState(){const t=Array.from(this.base.element.querySelectorAll(".item")),s=this.categories.map(o=>({name:o.name,items:Array.from(o.element.querySelectorAll(".item"))}));this.onChange&&this.onChange(t,s),new r().postToPg({event:"STATE_UPDATE",message:"State updated",reasons:[],state:JSON.stringify(this.getState())})}getState(){const t=Array.from(this.base.element.querySelectorAll(".item")),s=this.categories.map(e=>({name:e.name,items:Array.from(e.element.querySelectorAll(".item")).map(o=>o.dataset.itemId)}));return{base:t.map(e=>e.dataset.itemId),categories:s}}loadState(t){t.base.map(e=>document.querySelector(`[data-item-id="${e}"]`)).forEach(e=>this.base.element.appendChild(e)),t.categories.forEach(e=>{const o=this.categories.find(n=>n.name===e.name);o&&e.items.map(a=>document.querySelector(`[data-item-id="${a}"]`)).forEach(a=>o.element.appendChild(a))})}}class f{constructor(t){this.categories=t.categories,this.expectations=t.expectations,this.connectorColor=t.connector.color||"#000000",this.connectorWidth=t.connector.width||2,this.connectorRadius=t.connector.radius||5,this.onChange=t.onChange,this.connectorsContainer=t.connector.container,this.messages=t.messages,this.connectorsContainer.innerHTML="",this.relations={},this.connectorIdCounter=0,this.initItems(),this.setupDraggableItems(),this.pgEvent=new r,this.pgEvent.getValues(),this.pgEvent.data.state&&this.loadState(JSON.parse(this.pgEvent.data.state)),this.verifyButton=t.verifyButton,this.verifyButton.addEventListener("click",()=>this.validateConnections())}initItems(){this.categories.forEach(t=>{t.items.forEach(s=>{s.element&&s.element.addEventListener("mousedown",e=>this.onItemDragStart(e,s))})})}setupDraggableItems(){this.connector=null,this.startItem=null,document.addEventListener("mousemove",t=>{if(this.connector){const s=t.clientX,e=t.clientY;this.updateConnectorPosition(s,e)}}),document.addEventListener("mouseup",()=>{this.connector&&this.finalizeConnector()})}onItemDragStart(t,s){t.preventDefault(),this.startItem=s;const e=t.clientX,o=t.clientY;this.connector=document.createElement("div");const n=`connector-${this.connectorIdCounter++}`;this.connector.id=n,this.connector.style.position="absolute",this.connector.style.left=`${e}px`,this.connector.style.top=`${o}px`,this.connector.style.width=`${this.connectorWidth}px`,this.connector.style.height=`${this.connectorWidth}px`,this.connector.style.backgroundColor=this.connectorColor,this.connector.style.borderRadius=`${this.connectorRadius}px`,this.connector.style.cursor="pointer",this.connector.style.pointerEvents="auto",this.connector.dataset.relationKey=`${this.startItem.name}-${n}`,this.connector.startX=e,this.connector.startY=o,this.connector.addEventListener("click",a=>{a.stopPropagation(),this.removeConnectorAndRelation(n)}),this.connectorsContainer.appendChild(this.connector)}updateConnectorPosition(t,s){if(!this.connector)return;const e=this.connector.startX,o=this.connector.startY,n=t-e,a=s-o,i=Math.atan2(a,n)*180/Math.PI;this.connector.style.width=`${Math.abs(n)}px`,this.connector.style.height="4px",this.connector.style.transform=`rotate(${i}deg)`,this.connector.style.transformOrigin="0% 50%",this.connector.style.left=`${e}px`,this.connector.style.top=`${o}px`}finalizeConnector(){const t=document.elementFromPoint(event.clientX,event.clientY);if(!t||!this.isItemInCategories(t)||t===this.startItem.element){this.connectorsContainer.removeChild(this.connector),this.connector=null,this.startItem=null;return}const s=this.startItem.name,e=t.dataset.name;Object.keys(this.relations).forEach(n=>{const a=this.relations[n];(a.start.name===s||a.target.name===s||a.start.name===e||a.target.name===e)&&this.removeConnectorAndRelation(a.connector.id)}),this.relations[this.connectorIdCounter]={connector:this.connector,start:this.startItem,target:this.categories.flatMap(n=>n.items).find(n=>n.element===t)},Object.keys(this.relations).forEach(n=>{const a=this.relations[n];a.target.name===e&&n!==this.connectorIdCounter.toString()&&this.removeConnectorAndRelation(a.connector.id)}),this.onChange&&this.onChange(this.relations),new r().postToPg({event:"STATE_UPDATE",message:"State updated",reasons:[],state:JSON.stringify(this.getState())}),this.connector=null,this.startItem=null}removeConnectorAndRelation(t){const s=document.getElementById(t);if(s){s.parentElement.removeChild(s);for(const e in this.relations){const o=this.relations[e];if(o.connector&&o.connector.id===t){delete this.relations[e];break}}this.onChange&&this.onChange(this.relations)}}isItemInCategories(t){return this.categories.some(s=>s.items.some(e=>e.element===t))}validateConnections(){if(Object.keys(this.relations).length===0){console.log("Some connections are incorrect.");return}let t=!0;const s=new Set;for(const o in this.relations){const n=this.relations[o];if(!this.expectations.find(i=>{const c=i[0]===n.start.name&&i[1]===n.target.name||i[0]===n.target.name&&i[1]===n.start.name;return c&&s.add(i),c})){t=!1;break}}s.size!==this.expectations.length&&(t=!1);const e=new r;console.log(t?this.messages.onSuccess:this.messages.onFail),e.postToPg({event:t?"SUCCESS":"FAILURE",message:t?this.messages.onSuccess:this.messages.onFail,reasons:[],state:JSON.stringify(this.getState())})}getState(){return Object.keys(this.relations).map(t=>{const s=this.relations[t];return{start:s.start.name,target:s.target.name,connectorId:s.connector.id}})}loadState(t){t.forEach(s=>{const e=this.categories.flatMap(n=>n.items).find(n=>n.name===s.start),o=this.categories.flatMap(n=>n.items).find(n=>n.name===s.target);if(e&&o){const n=document.createElement("div");n.id=s.connectorId,n.style.position="absolute",n.style.backgroundColor=this.connectorColor,n.style.width=`${this.connectorWidth}px`,n.style.height=`${this.connectorWidth}px`,n.style.borderRadius=`${this.connectorRadius}px`,n.style.cursor="pointer",n.style.pointerEvents="auto",this.connectorsContainer.appendChild(n),this.relations[s.connectorId]={connector:n,start:e,target:o},this.updateConnectorPositionForLoadedState(n,e.element,o.element)}})}updateConnectorPositionForLoadedState(t,s,e){const o=s.getBoundingClientRect(),n=e.getBoundingClientRect(),a=o.left+o.width/2,i=o.top+o.height/2,c=n.left+n.width/2,d=n.top+n.height/2,l=c-a,m=d-i,g=Math.atan2(m,l)*180/Math.PI;t.style.width=`${Math.abs(l)}px`,t.style.height="4px",t.style.transform=`rotate(${g}deg)`,t.style.transformOrigin="0% 50%",t.style.left=`${a}px`,t.style.top=`${i}px`}}export{u as D,f as a};
